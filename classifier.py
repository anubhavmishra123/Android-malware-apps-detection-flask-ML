import os
import pickle
import joblib
import sklearn
print (sklearn.__version__)
from tensorflow.keras.models import load_model
from androguard.core.bytecodes.apk import APK



class CustomUnpickler(pickle.Unpickler):
    """ https://stackoverflow.com/questions/27732354/unable-to-load-files-using-pickle-and-multiple-modules"""

    def find_class(self, module, name):
        try:
            return super().find_class(__name__, name)
        except AttributeError:
            return super().find_class(module, name)


permissions = []
with open('/home/anu7861/mysite/static/permissions.txt', 'r') as f:
    content = f.readlines()
    for line in content:
        cur_perm = line[:-1]
        permissions.append(cur_perm)


def classify(file, ch):
    vector = {}
    result = 0
    name, sdk, size = 'unknown', 'unknown', 'unknown'
    app = APK(file)
    perm = app.get_permissions()
    name, sdk, size = meta_fetch(file)
    for p in permissions:
        if p in perm:
            vector[p] = 1
        else:
            vector[p] = 0
    data = [v for v in vector.values()]


    if ch == 0:
        ANN = load_model('/home/anu7861/mysite/static/models/AN_MODEL.h5',compile = False)
        #print(data)
        result = ANN.predict([[data]])
        print(result)

        if result < 0.50:
            # return 'Benign(safe)'
            result = 'Benign(safe)'
        else:
            # return 'Malware'
            result = 'Malware'
    if ch == 1:
        SVC = joblib.load('/home/anu7861/mysite/static/models/SVC_MODEL(1).pkl')
        result = SVC.predict([data])[0]
        #if result == 'benign':
        #result = 'Benign(safe)'
        #else:
        #result = 'Malware'
    if ch == 2:
        SVC = joblib.load('/home/anu7861/mysite/static/models/RF_MODEL(1).pkl')
        result = SVC.predict([data])[0]


    return result, name, sdk, size



def meta_fetch(apk):
    app = APK(apk)
    return app.get_app_name(), app.get_target_sdk_version(), str(round(os.stat(apk).st_size / (1024 * 1024), 2)) + ' MB'
